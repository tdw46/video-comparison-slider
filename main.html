<!DOCTYPE html>
<html>
<head>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap");

    :root {
      --bg: #0f0f0f;
      --panel: #181818;
      --panel-strong: #1d1d1d;
      --panel-weak: #2a2a2a;
      --text: #f1f1f1;
      --muted: #a3a3a3;
      --accent: #ff3d3d;
      --glow-r: 255;
      --glow-g: 61;
      --glow-b: 61;
      --glow-soft: rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.18);
      --glow-strong: rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.35);
      --shadow: 0 20px 45px rgba(0, 0, 0, 0.45);
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "Manrope", "Segoe UI", sans-serif;
      background: var(--bg);
      position: relative;
      overflow-x: hidden;
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: #2a2a2a #111111;
    }

    *::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    *::-webkit-scrollbar-track {
      background: #111111;
    }

    *::-webkit-scrollbar-thumb {
      background: #2a2a2a;
      border-radius: 999px;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(800px 520px at 18% 12%, var(--glow-soft), transparent 60%),
        radial-gradient(900px 600px at 85% 18%, rgba(255, 255, 255, 0.04), transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    #app {
      max-width: 100%;
      margin: 0 auto;
      padding: 1rem;
      position: relative;
      z-index: 1;
      height: 100dvh;
      overflow: hidden;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 360px;
      gap: 1.75rem;
      align-items: start;
      height: 100%;
      min-height: 0;
    }

    .main-column {
      min-width: 0;
      min-height: 0;
      height: 100%;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .video-panel {
      background: transparent;
      border-radius: var(--radius);
      padding: 0;
      box-shadow: none;
      position: relative;
      overflow: hidden;
    }

    .player-shell {
      position: relative;
    }

    .video-panel > * {
      position: relative;
      z-index: 1;
    }

    .transport {
      margin-top: 0.75rem;
      background: var(--panel);
      border-radius: 14px;
      padding: 0.85rem 1rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .transport-scrub {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .transport-scrub input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    .transport-time {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .transport-controls {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 0.75rem;
    }

    .transport-left {
      display: flex;
      align-items: center;
      gap: 0.65rem;
    }

    .transport-center {
      display: flex;
      justify-content: center;
    }

    .transport-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    .icon-button {
      border: none;
      border-radius: 999px;
      width: 42px;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--panel-weak);
      color: var(--text);
      cursor: pointer;
      transition: transform 0.15s ease, background 0.15s ease;
    }

    .icon-button:hover {
      background: #303030;
      transform: translateY(-1px);
    }

    .icon-button svg {
      width: 20px;
      height: 20px;
    }

    .icon-button .icon-pause {
      display: none;
    }

    .icon-button[data-playing="true"] .icon-play {
      display: none;
    }

    .icon-button[data-playing="true"] .icon-pause {
      display: block;
    }

    #lock-split .icon-lock-closed {
      display: none;
    }

    #lock-split[data-locked="true"] .icon-lock-open {
      display: none;
    }

    #lock-split[data-locked="true"] .icon-lock-closed {
      display: block;
    }

    .speed-buttons {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      flex-wrap: wrap;
    }

    .speed-option {
      border: none;
      background: #222222;
      color: var(--text);
      padding: 0.35rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .speed-option:hover {
      background: #303030;
    }

    .speed-option.active {
      background: var(--accent);
      color: #0f0f0f;
      font-weight: 600;
    }

    .fullscreen-tip {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: #fff;
      background: rgba(0, 0, 0, 0.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 6;
    }

    .fullscreen-tip.visible {
      opacity: 1;
    }

    body.fullscreen-active .transport {
      position: fixed;
      left: 50%;
      bottom: 16px;
      width: min(1120px, 94vw);
      margin: 0;
      transform: translate(-50%, 130%);
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      box-shadow: var(--shadow);
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    body.fullscreen-active.fullscreen-controls-visible .transport {
      transform: translate(-50%, 0);
      opacity: 1;
      pointer-events: auto;
    }

    .mute-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.25);
      color: #ffffff;
      font-size: 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      z-index: 5;
    }

    .mute-overlay.visible {
      opacity: 1;
      pointer-events: auto;
      cursor: pointer;
    }

    .mute-overlay .icon {
      width: 96px;
      height: 96px;
      background: rgba(0, 0, 0, 0.45);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(4px);
    }

    .mute-overlay svg {
      width: 46px;
      height: 46px;
    }

    #video-compare-container {
      display: inline-block;
      line-height: 0;
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      border-radius: calc(var(--radius) - 4px);
      overflow: hidden;
      background: #0b0b0b;
    }

    #video-compare-container > video {
      width: 100%;
      position: absolute;
      top: 0;
      height: 100%;
    }

    #video-clipper {
      width: 50%;
      position: absolute;
      top: 0;
      bottom: 0;
      overflow: hidden;
    }

    #video-clipper video {
      width: 200%;
      position: absolute;
      height: 100%;
    }

    .video-meta {
      padding: 0.9rem 0.1rem 0;
    }

    .video-meta h1 {
      margin: 0 0 0.35rem;
      font-size: clamp(1.35rem, 2vw, 1.8rem);
      font-weight: 700;
    }

    .video-meta p {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
    }

    .sidebar {
      position: sticky;
      top: 1rem;
      background: transparent;
      border-radius: 0;
      padding: 0.5rem 0;
      box-shadow: none;
      overflow: hidden;
      height: 100%;
      min-height: 0;
    }

    .sidebar-scroll {
      height: 100%;
      overflow-y: auto;
      padding-right: 0.5rem;
      min-height: 0;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .sync-chip {
      font-size: 0.75rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: #111111;
      color: var(--muted);
      white-space: nowrap;
    }

    #controls {
      display: grid;
      gap: 1rem;
      margin: 0;
      min-width: 0;
      position: relative;
    }

    .control-card {
      display: grid;
      grid-template-columns: 140px minmax(0, 1fr);
      gap: 0.9rem;
      padding: 0.25rem 0;
      min-width: 0;
      align-items: start;
    }

    .thumb {
      border-radius: 10px;
      overflow: hidden;
      background: #0c0c0c;
      aspect-ratio: 16 / 9;
      min-width: 0;
    }

    .thumb img,
    .thumb video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .control-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .control-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .settings-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: none;
      background: #1e1e1e;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
    }

    .settings-toggle svg {
      width: 16px;
      height: 16px;
    }

    .control-fields {
      display: grid;
      gap: 0.65rem;
      min-width: 0;
      overflow: visible;
    }

    .control-actions {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .file-button {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      background: #2a2a2a;
      color: var(--text);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      overflow: hidden;
    }

    .file-button input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .audio-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: #2a2a2a;
      border: none;
      color: var(--text);
      cursor: pointer;
      padding: 0;
    }

    .audio-toggle svg {
      width: 18px;
      height: 18px;
    }

    .audio-toggle .icon-on {
      display: none;
    }

    .audio-toggle[data-enabled="true"] .icon-on {
      display: block;
    }

    .audio-toggle[data-enabled="true"] .icon-off {
      display: none;
    }

    .control-settings {
      grid-column: 1 / -1;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 180ms ease, opacity 180ms ease;
      pointer-events: none;
    }

    .control-card.expanded .control-settings {
      max-height: 860px;
      opacity: 1;
      overflow: visible;
      pointer-events: auto;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      margin-top: 0.5rem;
    }

    .slider-row input[type="range"] {
      flex: 1;
      accent-color: var(--accent);
    }

    .slider-value {
      font-size: 0.85rem;
      color: var(--muted);
      min-width: 70px;
      text-align: right;
    }

    .offset-input {
      background: #1f1f1f;
      border: none;
      border-radius: 999px;
      color: var(--text);
      padding: 0.2rem 0.55rem;
      width: 80px;
      text-align: right;
      font-size: 0.85rem;
    }

    .pad-overlay {
      position: absolute;
      inset: 0;
      background: #000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 140ms ease;
      z-index: 2;
    }

    .pad-overlay.visible {
      opacity: 1;
    }

    .slider-hint {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.35rem;
    }

    .preview-frame {
      margin-top: 0.5rem;
      border-radius: 12px;
      overflow: hidden;
      background: #0c0c0c;
      aspect-ratio: 16 / 9;
    }

    .preview-frame video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .timeline {
      display: grid;
      gap: 0.4rem;
      margin-top: 0.6rem;
    }

    .timeline-strip {
      position: relative;
      width: 100%;
      height: 64px;
      border-radius: 10px;
      overflow: hidden;
      background: #0c0c0c;
    }

    .timeline-strip canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .trim-range {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.12);
      pointer-events: none;
    }

    .trim-dim {
      position: absolute;
      top: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.35);
      pointer-events: none;
    }

    .trim-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 8px;
      background: #ff3d3d;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.2);
      cursor: ew-resize;
      z-index: 3;
    }

    .trim-handle::after {
      content: "";
      position: absolute;
      top: 8px;
      bottom: 8px;
      left: 2px;
      right: 2px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    .timeline input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    .timeline-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--muted);
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: static;
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="layout">
      <div class="main-column">
        <div class="player-shell">
          <div class="video-panel">
            <div id="video-compare-container">
              <video id='src' loop autoplay playsinline onclick="video_click()">
                <source src="resources/2 - 15 sec - 1000 frame - AI Girl Perks - Replacement.mp4">
                <!-- <source src=/loca/path/to/your/mp4> -->
              </video>
              <div id="video-clipper">
                <video id='tgt' loop autoplay playsinline onclick="video_click()">
                  <source src="resources/2 - 15 sec - 1000 frame - AI Girl Perks.mp4">
                  <!-- <source src=/home/yun/out2.mp4> -->
                </video>
                <div id="left-pad" class="pad-overlay"></div>
              </div>
              <div id="right-pad" class="pad-overlay"></div>
              <div id="mute-overlay" class="mute-overlay" aria-label="Click to unmute" role="button" tabindex="0">
                <div class="icon">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 9v6h4l5 4V5L8 9H4z" fill="currentColor"></path>
                    <path d="M19 5L5 19" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                  </svg>
                </div>
              </div>
              <div id="fullscreen-tip" class="fullscreen-tip">Press ESC to exit fullscreen</div>
            </div>
          </div>
          <div class="transport">
            <div class="transport-scrub">
              <input id="master-scrubber" type="range" min="0" max="0" step="0.01" value="0">
              <div class="transport-time">
                <span id="master-current">0:00</span>
                <span id="master-duration">0:00</span>
              </div>
            </div>
            <div class="transport-controls">
              <div class="transport-left">
                <button id="master-play" class="icon-button" type="button" aria-label="Play/Pause" data-playing="false">
                  <svg class="icon-play" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M8 5l11 7-11 7V5z" fill="currentColor"></path>
                  </svg>
                  <svg class="icon-pause" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M7 5h4v14H7zM13 5h4v14h-4z" fill="currentColor"></path>
                  </svg>
                </button>
              </div>
              <div class="transport-center">
                <div class="speed-buttons" role="group" aria-label="Playback speed">
                  <button class="speed-option" type="button" data-rate="0.25">0.25x</button>
                  <button class="speed-option" type="button" data-rate="0.5">0.5x</button>
                  <button class="speed-option" type="button" data-rate="0.75">0.75x</button>
                  <button class="speed-option active" type="button" data-rate="1">1.0x</button>
                  <button class="speed-option" type="button" data-rate="1.25">1.25x</button>
                  <button class="speed-option" type="button" data-rate="1.75">1.75x</button>
                  <button class="speed-option" type="button" data-rate="2">2.0x</button>
                </div>
              </div>
              <div class="transport-right">
                <button id="lock-split" class="icon-button" type="button" aria-label="Lock comparison split" data-locked="false" title="Lock split position">
                  <svg class="icon-lock-open" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M7 10V7a5 5 0 1 1 10 0h-2a3 3 0 0 0-6 0v3H7z" fill="currentColor"></path>
                    <rect x="5" y="10" width="14" height="10" rx="2" fill="currentColor"></rect>
                  </svg>
                  <svg class="icon-lock-closed" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M7 10V7a5 5 0 0 1 10 0v3h-2V7a3 3 0 0 0-6 0v3H7z" fill="currentColor"></path>
                    <rect x="5" y="10" width="14" height="10" rx="2" fill="currentColor"></rect>
                  </svg>
                </button>
                <button id="master-fullscreen" class="icon-button" type="button" aria-label="Toggle fullscreen">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 9V4h5v2H6v3H4zm10-5h6v6h-2V6h-4V4zM4 14h2v4h4v2H4v-6zm14 0h2v6h-6v-2h4v-4z" fill="currentColor"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="video-meta">
          <h1>A vs B</h1>
          <p>Click the video to play or pause. Drag across the frame to reveal the comparison.</p>
        </div>
      </div>

      <aside class="sidebar">
        <div class="sidebar-scroll">
          <div class="sidebar-header">
            <h2>Controls</h2>
            <span class="sync-chip">Synced</span>
          </div>
          <div id="controls">
          <div class="control-card">
            <div class="thumb">
              <video id="left-thumb" muted playsinline preload="metadata"></video>
            </div>
            <div class="control-fields">
              <div class="control-title-row">
                <div class="control-title">Left video</div>
                <button class="settings-toggle" type="button" aria-label="Left video settings" aria-expanded="false">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M19.4 13.5c.04-.33.06-.67.06-1.02s-.02-.69-.06-1.02l2.02-1.57a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.38.96a7.3 7.3 0 0 0-1.76-1.02l-.36-2.54a.5.5 0 0 0-.5-.42h-3.84a.5.5 0 0 0-.5.42l-.36 2.54c-.62.24-1.22.57-1.76 1.02l-2.38-.96a.5.5 0 0 0-.6.22L2.5 8.75a.5.5 0 0 0 .12.64l2.02 1.57c-.04.33-.06.67-.06 1.02s.02.69.06 1.02L2.62 14.6a.5.5 0 0 0-.12.64l1.92 3.32c.14.24.44.34.7.22l2.38-.96c.54.44 1.14.78 1.76 1.02l.36 2.54c.04.24.26.42.5.42h3.84c.24 0 .46-.18.5-.42l.36-2.54c.62-.24 1.22-.57 1.76-1.02l2.38.96c.26.12.56.02.7-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.02-1.57zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z" fill="currentColor"></path>
                  </svg>
                </button>
              </div>
              <div class="control-actions">
                <label class="file-button">
                  <input id="left-file" type="file" accept="video/*">
                  Choose file
                </label>
                <button id="left-audio" class="audio-toggle" type="button" aria-pressed="false" aria-label="Toggle left audio" data-enabled="false" title="Toggle audio">
                  <svg class="icon-on" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 9v6h4l5 4V5L8 9H4z" fill="currentColor"></path>
                    <path d="M16 8.5c1.5 1 2.5 2.6 2.5 4.5s-1 3.5-2.5 4.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                  </svg>
                  <svg class="icon-off" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 9v6h4l5 4V5L8 9H4z" fill="currentColor"></path>
                    <path d="M19 5L5 19" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div class="control-settings">
              <div class="control-title">Track offset</div>
              <div class="slider-row">
                <input id="left-offset" type="range" min="-2" max="2" step="0.05" value="0">
                <input id="left-offset-value" class="offset-input" type="text" inputmode="decimal" value="0">
              </div>
              <div class="slider-hint">Negative leads, positive lags.</div>
              <div class="control-title">Clip range</div>
              <div class="preview-frame">
                <video id="left-preview" muted playsinline preload="metadata"></video>
              </div>
              <div class="timeline">
                <div class="timeline-strip" id="left-timeline">
                  <canvas id="left-strip" width="320" height="64"></canvas>
                  <div id="left-range" class="trim-range"></div>
                  <div id="left-dim-left" class="trim-dim"></div>
                  <div id="left-dim-right" class="trim-dim"></div>
                  <div id="left-handle-start" class="trim-handle"></div>
                  <div id="left-handle-end" class="trim-handle"></div>
                </div>
                <input id="left-clip-start" type="hidden" value="0">
                <input id="left-clip-end" type="hidden" value="0">
                <div class="timeline-labels">
                  <span id="left-clip-start-label">0.00s</span>
                  <span id="left-clip-end-label">0.00s</span>
                </div>
              </div>
              <div class="slider-row">
                <button id="left-length-mode" class="file-button" type="button">Clip to other</button>
                <span id="left-clip-length" class="slider-value">0.00s</span>
              </div>
              <div class="slider-row">
                <label class="control-title">Prioritize for loops</label>
                <button id="left-loop-priority" class="audio-toggle" type="button" aria-pressed="false" data-enabled="false" title="Prioritize looping">
                  <svg class="icon-on" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 12a8 8 0 0 1 14.31-4.31L20 6v5h-5l1.85-1.85A6 6 0 0 0 6 12h2l-3 3-3-3h2zm16 0a8 8 0 0 1-14.31 4.31L4 18v-5h5l-1.85 1.85A6 6 0 0 0 18 12h-2l3-3 3 3h-2z" fill="currentColor"></path>
                  </svg>
                  <svg class="icon-off" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 12a8 8 0 0 1 14.31-4.31L20 6v5h-5l1.85-1.85A6 6 0 0 0 6 12h2l-3 3-3-3h2z" fill="currentColor"></path>
                    <path d="M19 5L5 19" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div class="control-card">
            <div class="thumb">
              <video id="right-thumb" muted playsinline preload="metadata"></video>
            </div>
            <div class="control-fields">
              <div class="control-title-row">
                <div class="control-title">Right video</div>
                <button class="settings-toggle" type="button" aria-label="Right video settings" aria-expanded="false">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M19.4 13.5c.04-.33.06-.67.06-1.02s-.02-.69-.06-1.02l2.02-1.57a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.38.96a7.3 7.3 0 0 0-1.76-1.02l-.36-2.54a.5.5 0 0 0-.5-.42h-3.84a.5.5 0 0 0-.5.42l-.36 2.54c-.62.24-1.22.57-1.76 1.02l-2.38-.96a.5.5 0 0 0-.6.22L2.5 8.75a.5.5 0 0 0 .12.64l2.02 1.57c-.04.33-.06.67-.06 1.02s.02.69.06 1.02L2.62 14.6a.5.5 0 0 0-.12.64l1.92 3.32c.14.24.44.34.7.22l2.38-.96c.54.44 1.14.78 1.76 1.02l.36 2.54c.04.24.26.42.5.42h3.84c.24 0 .46-.18.5-.42l.36-2.54c.62-.24 1.22-.57 1.76-1.02l2.38.96c.26.12.56.02.7-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.02-1.57zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z" fill="currentColor"></path>
                  </svg>
                </button>
              </div>
              <div class="control-actions">
                <label class="file-button">
                  <input id="right-file" type="file" accept="video/*">
                  Choose file
                </label>
                <button id="right-audio" class="audio-toggle" type="button" aria-pressed="true" aria-label="Toggle right audio" data-enabled="true" title="Toggle audio">
                  <svg class="icon-on" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 9v6h4l5 4V5L8 9H4z" fill="currentColor"></path>
                    <path d="M16 8.5c1.5 1 2.5 2.6 2.5 4.5s-1 3.5-2.5 4.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                  </svg>
                  <svg class="icon-off" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 9v6h4l5 4V5L8 9H4z" fill="currentColor"></path>
                    <path d="M19 5L5 19" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div class="control-settings">
              <div class="control-title">Track offset</div>
              <div class="slider-row">
                <input id="right-offset" type="range" min="-2" max="2" step="0.05" value="0">
                <input id="right-offset-value" class="offset-input" type="text" inputmode="decimal" value="0">
              </div>
              <div class="slider-hint">Negative leads, positive lags.</div>
              <div class="control-title">Clip range</div>
              <div class="preview-frame">
                <video id="right-preview" muted playsinline preload="metadata"></video>
              </div>
              <div class="timeline">
                <div class="timeline-strip" id="right-timeline">
                  <canvas id="right-strip" width="320" height="64"></canvas>
                  <div id="right-range" class="trim-range"></div>
                  <div id="right-dim-left" class="trim-dim"></div>
                  <div id="right-dim-right" class="trim-dim"></div>
                  <div id="right-handle-start" class="trim-handle"></div>
                  <div id="right-handle-end" class="trim-handle"></div>
                </div>
                <input id="right-clip-start" type="hidden" value="0">
                <input id="right-clip-end" type="hidden" value="0">
                <div class="timeline-labels">
                  <span id="right-clip-start-label">0.00s</span>
                  <span id="right-clip-end-label">0.00s</span>
                </div>
              </div>
              <div class="slider-row">
                <button id="right-length-mode" class="file-button" type="button">Pad to other</button>
                <span id="right-clip-length" class="slider-value">0.00s</span>
              </div>
              <div class="slider-row">
                <label class="control-title">Prioritize for loops</label>
                <button id="right-loop-priority" class="audio-toggle" type="button" aria-pressed="true" data-enabled="true" title="Prioritize looping">
                  <svg class="icon-on" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 12a8 8 0 0 1 14.31-4.31L20 6v5h-5l1.85-1.85A6 6 0 0 0 6 12h2l-3 3-3-3h2zm16 0a8 8 0 0 1-14.31 4.31L4 18v-5h5l-1.85 1.85A6 6 0 0 0 18 12h-2l3-3 3 3h-2z" fill="currentColor"></path>
                  </svg>
                  <svg class="icon-off" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 12a8 8 0 0 1 14.31-4.31L20 6v5h-5l1.85-1.85A6 6 0 0 0 6 12h2l-3 3-3-3h2z" fill="currentColor"></path>
                    <path d="M19 5L5 19" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    var v = document.getElementById("src");
    var v2 = document.getElementById("tgt");

    var leftFile = document.getElementById("left-file");
    var rightFile = document.getElementById("right-file");
    var leftAudio = document.getElementById("left-audio");
    var rightAudio = document.getElementById("right-audio");
    var leftThumb = document.getElementById("left-thumb");
    var rightThumb = document.getElementById("right-thumb");
    var muteOverlay = document.getElementById("mute-overlay");
    var leftOffset = document.getElementById("left-offset");
    var rightOffset = document.getElementById("right-offset");
    var leftOffsetValue = document.getElementById("left-offset-value");
    var rightOffsetValue = document.getElementById("right-offset-value");
    var leftClipStart = document.getElementById("left-clip-start");
    var leftClipEnd = document.getElementById("left-clip-end");
    var rightClipStart = document.getElementById("right-clip-start");
    var rightClipEnd = document.getElementById("right-clip-end");
    var leftClipStartLabel = document.getElementById("left-clip-start-label");
    var leftClipEndLabel = document.getElementById("left-clip-end-label");
    var rightClipStartLabel = document.getElementById("right-clip-start-label");
    var rightClipEndLabel = document.getElementById("right-clip-end-label");
    var leftTimeline = document.getElementById("left-timeline");
    var rightTimeline = document.getElementById("right-timeline");
    var leftStrip = document.getElementById("left-strip");
    var rightStrip = document.getElementById("right-strip");
    var leftRange = document.getElementById("left-range");
    var rightRange = document.getElementById("right-range");
    var leftHandleStart = document.getElementById("left-handle-start");
    var leftHandleEnd = document.getElementById("left-handle-end");
    var rightHandleStart = document.getElementById("right-handle-start");
    var rightHandleEnd = document.getElementById("right-handle-end");
    var leftDimLeft = document.getElementById("left-dim-left");
    var leftDimRight = document.getElementById("left-dim-right");
    var rightDimLeft = document.getElementById("right-dim-left");
    var rightDimRight = document.getElementById("right-dim-right");
    var leftLengthMode = document.getElementById("left-length-mode");
    var rightLengthMode = document.getElementById("right-length-mode");
    var leftClipLength = document.getElementById("left-clip-length");
    var rightClipLength = document.getElementById("right-clip-length");
    var leftPad = document.getElementById("left-pad");
    var rightPad = document.getElementById("right-pad");
    var leftPreview = document.getElementById("left-preview");
    var rightPreview = document.getElementById("right-preview");
    var leftLoopPriority = document.getElementById("left-loop-priority");
    var rightLoopPriority = document.getElementById("right-loop-priority");
    var masterScrubber = document.getElementById("master-scrubber");
    var masterCurrent = document.getElementById("master-current");
    var masterDurationLabel = document.getElementById("master-duration");
    var masterPlayButton = document.getElementById("master-play");
    var masterFullscreen = document.getElementById("master-fullscreen");
    var fullscreenTip = document.getElementById("fullscreen-tip");
    var lockSplitButton = document.getElementById("lock-split");
    var speedButtons = document.querySelectorAll(".speed-option");
    var playbackRate = 1;
    var isScrubbing = false;
    var fullscreenTimer = null;
    var fullscreenActive = false;
    var fullscreenControlsVisible = false;
    var fullscreenHideTimer = null;
    var fullscreenMoveHandler = null;
    var scrubRAF = null;
    var scrubPending = null;
    var isSplitLocked = false;

    var leftObjectUrl = null;
    var rightObjectUrl = null;
    var glowCanvas = document.createElement("canvas");
    var glowContext = glowCanvas.getContext("2d", { willReadFrequently: true });
    var autoplayAttempted = false;
    var glowInterval = null;
    var lastRightOffset = 0;
    var masterTime = 0;
    var masterDuration = 0;
    var isPlaying = false;
    var lastTick = null;
    var userInteracted = false;
    var audioUnlocked = false;
    var prevRightPadActive = false;
    var prevLeftPadActive = false;
    var leftStripSrc = "";
    var rightStripSrc = "";
    var leftStripBuilt = false;
    var rightStripBuilt = false;
    var playToken = 0;
    var playQueued = false;
    var debugLog = [];
    var lastAudioState = {
      rightPad: null,
      leftPad: null,
      rightEnabled: null,
      leftEnabled: null,
      unlocked: null,
      rightMuted: null,
      leftMuted: null
    };

    function dbg(label, data) {
      try {
        var entry = { t: Date.now(), label: label, data: data || {} };
        debugLog.push(entry);
        if (debugLog.length > 250) {
          debugLog.shift();
        }
        if (window && window.DEBUG_AVS) {
          console.log("[AVS]", label, data || {});
        }
      } catch (error) {
        // ignore debug errors
      }
    }

    window.AVS_DEBUG_DUMP = function () {
      try {
        return JSON.stringify(debugLog, null, 2);
      } catch (error) {
        return String(debugLog);
      }
    };

    window.AVS_DEBUG_STATE = function () {
      return {
        userInteracted: userInteracted,
        audioUnlocked: audioUnlocked,
        isPlaying: isPlaying,
        masterTime: masterTime,
        masterDuration: masterDuration,
        rightMuted: v.muted,
        leftMuted: v2.muted,
        rightPaused: v.paused,
        leftPaused: v2.paused,
        rightCurrent: v.currentTime,
        leftCurrent: v2.currentTime,
        rightClip: { start: rightClipStart.value, end: rightClipEnd.value },
        leftClip: { start: leftClipStart.value, end: leftClipEnd.value },
        rightOffset: rightOffset.value,
        leftOffset: leftOffset.value,
        rightPriority: isAudioEnabled(rightLoopPriority),
        leftPriority: isAudioEnabled(leftLoopPriority)
      };
    };

    function isAudioEnabled(button) {
      return button.dataset.enabled === "true";
    }

    function setAudioEnabled(button, enabled) {
      button.dataset.enabled = enabled ? "true" : "false";
      button.setAttribute("aria-pressed", enabled ? "true" : "false");
    }

    function getVideoSrc(video) {
      if (video.currentSrc) {
        return video.currentSrc;
      }
      var source = video.querySelector("source");
      return source ? source.src : "";
    }

    function updateAudioState(rightPadActive, leftPadActive) {
      var rightEnabled = isAudioEnabled(rightAudio);
      var leftEnabled = isAudioEnabled(leftAudio);
      var allowAudio = audioUnlocked;
      var desiredRightMuted = !allowAudio || rightPadActive || !rightEnabled;
      var desiredLeftMuted = !allowAudio || leftPadActive || !leftEnabled;
      if (v.muted !== desiredRightMuted) {
        v.muted = desiredRightMuted;
      }
      if (v2.muted !== desiredLeftMuted) {
        v2.muted = desiredLeftMuted;
      }
      if (!desiredRightMuted) {
        v.volume = 1;
      }
      if (!desiredLeftMuted) {
        v2.volume = 1;
      }
      updateMuteOverlay();
      if (
        lastAudioState.rightMuted !== desiredRightMuted ||
        lastAudioState.leftMuted !== desiredLeftMuted ||
        lastAudioState.rightPad !== rightPadActive ||
        lastAudioState.leftPad !== leftPadActive ||
        lastAudioState.unlocked !== audioUnlocked ||
        lastAudioState.rightEnabled !== rightEnabled ||
        lastAudioState.leftEnabled !== leftEnabled
      ) {
        lastAudioState = {
          rightPad: rightPadActive,
          leftPad: leftPadActive,
          rightEnabled: rightEnabled,
          leftEnabled: leftEnabled,
          unlocked: audioUnlocked,
          rightMuted: desiredRightMuted,
          leftMuted: desiredLeftMuted
        };
        dbg("audioState", {
          userInteracted: userInteracted,
          audioUnlocked: audioUnlocked,
          rightEnabled: rightEnabled,
          leftEnabled: leftEnabled,
          rightMuted: desiredRightMuted,
          leftMuted: desiredLeftMuted,
          rightPadActive: rightPadActive,
          leftPadActive: leftPadActive
        });
      }
    }

    function applyAudioSettings() {
      updateAudioState(prevRightPadActive, prevLeftPadActive);
      dbg("applyAudioSettings", {
        userInteracted: userInteracted,
        audioUnlocked: audioUnlocked,
        rightEnabled: isAudioEnabled(rightAudio),
        leftEnabled: isAudioEnabled(leftAudio),
        rightMuted: v.muted,
        leftMuted: v2.muted
      });
    }

    function formatOffset(value) {
      return value.toFixed(2);
    }

    function updateOffsetInputs() {
      leftOffsetValue.value = formatOffset(parseFloat(leftOffset.value || "0"));
      rightOffsetValue.value = formatOffset(parseFloat(rightOffset.value || "0"));
    }

    function wrapTime(time, duration) {
      if (!isFinite(duration) || duration <= 0) {
        return time;
      }
      var wrapped = time % duration;
      if (wrapped < 0) {
        wrapped += duration;
      }
      return wrapped;
    }

    function parseNumber(value, fallback) {
      var parsed = parseFloat(value);
      return isFinite(parsed) ? parsed : fallback;
    }

    function clamp(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }

    function formatTime(seconds) {
      if (!isFinite(seconds) || seconds <= 0) {
        return "0:00";
      }
      var total = Math.floor(seconds);
      var minutes = Math.floor(total / 60);
      var secs = total % 60;
      return minutes + ":" + (secs < 10 ? "0" + secs : secs);
    }

    function updateTransportUI() {
      var duration = isFinite(masterDuration) ? masterDuration : 0;
      var current = isFinite(masterTime) ? masterTime : 0;
      if (isScrubbing) {
        current = parseNumber(masterScrubber.value, current);
      }
      masterCurrent.textContent = formatTime(current);
      masterDurationLabel.textContent = formatTime(duration);
      masterPlayButton.dataset.playing = isPlaying ? "true" : "false";
      if (!isScrubbing) {
        masterScrubber.max = duration > 0 ? duration.toFixed(2) : "0";
        masterScrubber.value = duration > 0 ? clamp(current, 0, duration).toFixed(2) : "0";
      }
      masterScrubber.disabled = !(duration > 0);
    }

    function getSegment(video, startInput, endInput) {
      if (!isFinite(video.duration) || video.duration <= 0) {
        return { start: 0, end: 0, length: 0, duration: 0 };
      }
      var start = clamp(parseNumber(startInput.value, 0), 0, video.duration);
      var end = clamp(parseNumber(endInput.value, video.duration), 0, video.duration);
      if (end < start) {
        end = start;
      }
      return { start: start, end: end, length: end - start, duration: video.duration };
    }

    function ensureClipDefaults(video, startInput, endInput) {
      if (!isFinite(video.duration) || video.duration <= 0) {
        return;
      }
      var start = parseNumber(startInput.value, 0);
      var end = parseNumber(endInput.value, 0);
      if (end <= start || end === 0) {
        startInput.value = "0";
        endInput.value = video.duration.toFixed(2);
      }
    }

    function updateClipLabels() {
      var leftSeg = getSegment(v2, leftClipStart, leftClipEnd);
      var rightSeg = getSegment(v, rightClipStart, rightClipEnd);
      leftClipLength.textContent = leftSeg.length.toFixed(2) + "s";
      rightClipLength.textContent = rightSeg.length.toFixed(2) + "s";
      leftClipStartLabel.textContent = leftSeg.start.toFixed(2) + "s";
      leftClipEndLabel.textContent = leftSeg.end.toFixed(2) + "s";
      rightClipStartLabel.textContent = rightSeg.start.toFixed(2) + "s";
      rightClipEndLabel.textContent = rightSeg.end.toFixed(2) + "s";
      updateLengthModeButtons(leftSeg.length, rightSeg.length);
    }

    function updateLengthModeButtons(leftLen, rightLen) {
      if (!(leftLen > 0) || !(rightLen > 0)) {
        leftLengthMode.textContent = "Clip to other";
        rightLengthMode.textContent = "Pad to other";
        return;
      }
      if (leftLen >= rightLen) {
        leftLengthMode.textContent = "Clip to other";
        rightLengthMode.textContent = "Pad to other";
      } else {
        leftLengthMode.textContent = "Pad to other";
        rightLengthMode.textContent = "Clip to other";
      }
    }

    function applyAutoLength(side) {
      var leftSeg = getSegment(v2, leftClipStart, leftClipEnd);
      var rightSeg = getSegment(v, rightClipStart, rightClipEnd);
      if (!(leftSeg.length > 0) || !(rightSeg.length > 0)) {
        return;
      }
      if (side === "left") {
        if (leftSeg.length >= rightSeg.length) {
          leftClipEnd.value = (leftSeg.start + rightSeg.length).toFixed(2);
          clampClipRanges();
          updateClipLabels();
          updateTrimUI("left");
          updateMasterDuration();
          syncFromMaster(true);
        }
      } else {
        if (rightSeg.length >= leftSeg.length) {
          rightClipEnd.value = (rightSeg.start + leftSeg.length).toFixed(2);
          clampClipRanges();
          updateClipLabels();
          updateTrimUI("right");
          updateMasterDuration();
          syncFromMaster(true);
        }
      }
    }

    function getEffectiveDuration(isRight) {
      var leftSeg = getSegment(v2, leftClipStart, leftClipEnd);
      var rightSeg = getSegment(v, rightClipStart, rightClipEnd);
      var leftLen = leftSeg.length;
      var rightLen = rightSeg.length;
      if (!(leftLen > 0) || !(rightLen > 0)) {
        return isRight ? rightLen : leftLen;
      }
      var isThisLonger = isRight ? rightLen >= leftLen : leftLen >= rightLen;
      var mode = isThisLonger ? "clip" : "pad";
      return mode === "pad" ? Math.max(leftLen, rightLen) : Math.min(leftLen, rightLen);
    }

    function getMasterSide() {
      return isAudioEnabled(rightLoopPriority) ? "right" : "left";
    }

    function syncFromMaster(force) {
      if (!isFinite(masterDuration) || masterDuration <= 0) {
        return;
      }

      var rightSeg = getSegment(v, rightClipStart, rightClipEnd);
      var leftSeg = getSegment(v2, leftClipStart, leftClipEnd);
      var rightOffsetValue = parseNumber(rightOffset.value, 0);
      var leftOffsetVal = parseNumber(leftOffset.value, 0);
      var masterSide = getMasterSide();

      var masterVideo = masterSide === "right" ? v : v2;
      var masterSeg = masterSide === "right" ? rightSeg : leftSeg;
      var masterOffset = masterSide === "right" ? rightOffsetValue : leftOffsetVal;
      var masterLen = masterSeg.length;
      if (!(masterLen > 0)) {
        return;
      }

      masterTime = wrapTime(masterVideo.currentTime - masterSeg.start - masterOffset, masterLen);
      var masterTarget = masterSeg.start + wrapTime(masterTime + masterOffset, masterLen);
      if (masterVideo.currentTime < masterSeg.start || masterVideo.currentTime > masterSeg.end + 0.02) {
        masterVideo.currentTime = masterTarget;
      }

      var otherVideo = masterSide === "right" ? v2 : v;
      var otherSeg = masterSide === "right" ? leftSeg : rightSeg;
      var otherOffset = masterSide === "right" ? leftOffsetVal : rightOffsetValue;
      var otherLen = otherSeg.length;
      var otherRelative = masterTime + otherOffset;
      var otherPadActive = true;
      var desiredOther = otherSeg.start;
      if (otherLen > 0) {
        if (otherRelative < 0) {
          desiredOther = otherSeg.start;
          otherPadActive = true;
        } else if (otherRelative >= otherLen) {
          desiredOther = Math.max(otherSeg.start, otherSeg.end - 0.02);
          otherPadActive = true;
        } else {
          desiredOther = otherSeg.start + otherRelative;
          otherPadActive = false;
        }
      }

      var rightPadActive = masterSide === "right" ? false : otherPadActive;
      var leftPadActive = masterSide === "left" ? false : otherPadActive;

      rightPad.classList.toggle("visible", rightPadActive);
      leftPad.classList.toggle("visible", leftPadActive);

      if (otherLen > 0) {
        var drift = Math.abs(otherVideo.currentTime - desiredOther);
        var driftThreshold = 0.12;
        if (force || drift > driftThreshold) {
          otherVideo.currentTime = desiredOther;
        }
      }

      if (isPlaying) {
        if (masterVideo.paused) {
          masterVideo.play().catch(function () {});
        }
        if (otherPadActive) {
          if (!otherVideo.paused) {
            otherVideo.pause();
          }
        } else if (otherVideo.paused) {
          otherVideo.play().catch(function () {});
        }
      }

      prevRightPadActive = rightPadActive;
      prevLeftPadActive = leftPadActive;
      updateAudioState(rightPadActive, leftPadActive);
      updateTransportUI();
      if (force) {
        dbg("syncFromMaster", {
          rightPadActive: rightPadActive,
          leftPadActive: leftPadActive,
          rightMuted: v.muted,
          leftMuted: v2.muted,
          masterTime: masterTime
        });
      }
    }

    function setThumbSource(thumbVideo, src) {
      if (!src) {
        return;
      }
      thumbVideo.src = src;
      thumbVideo.load();
    }

    function setPreviewSource(previewVideo, src) {
      if (!src) {
        return;
      }
      previewVideo.muted = true;
      previewVideo.volume = 0;
      previewVideo.src = src;
      previewVideo.load();
    }

    function clampClipRanges() {
      var leftSeg = getSegment(v2, leftClipStart, leftClipEnd);
      var rightSeg = getSegment(v, rightClipStart, rightClipEnd);
      leftClipStart.value = leftSeg.start.toFixed(2);
      leftClipEnd.value = leftSeg.end.toFixed(2);
      rightClipStart.value = rightSeg.start.toFixed(2);
      rightClipEnd.value = rightSeg.end.toFixed(2);
    }

    function updateTrimUI(side) {
      var timeline = side === "left" ? leftTimeline : rightTimeline;
      var startHandle = side === "left" ? leftHandleStart : rightHandleStart;
      var endHandle = side === "left" ? leftHandleEnd : rightHandleEnd;
      var range = side === "left" ? leftRange : rightRange;
      var startInput = side === "left" ? leftClipStart : rightClipStart;
      var endInput = side === "left" ? leftClipEnd : rightClipEnd;
      var dimLeft = side === "left" ? leftDimLeft : rightDimLeft;
      var dimRight = side === "left" ? leftDimRight : rightDimRight;
      var video = side === "left" ? v2 : v;
      var duration = isFinite(video.duration) && video.duration > 0 ? video.duration : 0;
      var start = parseNumber(startInput.value, 0);
      var end = parseNumber(endInput.value, duration);
      if (duration <= 0) {
        return;
      }
      if (end <= start) {
        end = duration;
        startInput.value = "0";
        endInput.value = duration.toFixed(2);
      }
      var startPct = clamp(start / duration, 0, 1);
      var endPct = clamp(end / duration, 0, 1);
      var width = timeline.clientWidth;
      if (width <= 0) {
        return;
      }
      var handleHalf = 4;
      var startX = clamp(startPct * width, handleHalf, width - handleHalf);
      var endX = clamp(endPct * width, handleHalf, width - handleHalf);
      startHandle.style.left = startX + "px";
      endHandle.style.left = endX + "px";
      range.style.left = startX + "px";
      range.style.right = (width - endX) + "px";
      dimLeft.style.left = "0px";
      dimLeft.style.width = startX + "px";
      dimRight.style.right = "0px";
      dimRight.style.width = (width - endX) + "px";
    }

    function initTrimDrag(side) {
      var timeline = side === "left" ? leftTimeline : rightTimeline;
      var startHandle = side === "left" ? leftHandleStart : rightHandleStart;
      var endHandle = side === "left" ? leftHandleEnd : rightHandleEnd;
      var startInput = side === "left" ? leftClipStart : rightClipStart;
      var endInput = side === "left" ? leftClipEnd : rightClipEnd;
      var preview = side === "left" ? leftPreview : rightPreview;
      var video = side === "left" ? v2 : v;
      var dragTarget = { handle: null };

      function pointerToValue(clientX) {
        var rect = timeline.getBoundingClientRect();
        var pct = clamp((clientX - rect.left) / rect.width, 0, 1);
        var duration = isFinite(video.duration) && video.duration > 0 ? video.duration : 0;
        return pct * duration;
      }

    function updateFromDrag(clientX) {
      if (!dragTarget.handle) {
        return;
      }
      pauseMaster();
      var value = pointerToValue(clientX);
      var startVal = parseNumber(startInput.value, 0);
      var endVal = parseNumber(endInput.value, video.duration || 0);
        if (dragTarget.handle === "start") {
          startVal = Math.min(value, endVal);
          startInput.value = startVal.toFixed(2);
        } else {
          endVal = Math.max(value, startVal);
          endInput.value = endVal.toFixed(2);
        }
        clampClipRanges();
        updateClipLabels();
        updateTrimUI(side);
      updateMasterDuration();
      syncFromMaster(true);
      playPreview(preview, startInput, endInput);
    }

      function startDrag(handle, event) {
        dragTarget.handle = handle;
        timeline.setPointerCapture(event.pointerId);
        updateFromDrag(event.clientX);
      }

      timeline.addEventListener("pointermove", function (event) {
        if (dragTarget.handle) {
          updateFromDrag(event.clientX);
        }
      });

      timeline.addEventListener("pointerup", function (event) {
        if (!dragTarget.handle) {
          return;
        }
        dragTarget.handle = null;
        if (timeline.hasPointerCapture(event.pointerId)) {
          timeline.releasePointerCapture(event.pointerId);
        }
        requestPlayMaster("trim-pointerup");
      });

      timeline.addEventListener("pointercancel", function (event) {
        if (!dragTarget.handle) {
          return;
        }
        dragTarget.handle = null;
        if (timeline.hasPointerCapture(event.pointerId)) {
          timeline.releasePointerCapture(event.pointerId);
        }
        requestPlayMaster("trim-cancel");
      });

      window.addEventListener("pointerup", function (event) {
        if (!dragTarget.handle) {
          return;
        }
        dragTarget.handle = null;
        if (timeline.hasPointerCapture(event.pointerId)) {
          timeline.releasePointerCapture(event.pointerId);
        }
        requestPlayMaster("trim-window-up");
      });

      startHandle.addEventListener("pointerdown", function (event) {
        startDrag("start", event);
      });

      endHandle.addEventListener("pointerdown", function (event) {
        startDrag("end", event);
      });
    }

    function buildFrameStrip(previewVideo, canvas, onDone) {
      var src = previewVideo.currentSrc || previewVideo.src;
      if (!src) {
        return;
      }
      var ctx = canvas.getContext("2d");
      var stripVideo = document.createElement("video");
      stripVideo.muted = true;
      stripVideo.playsInline = true;
      stripVideo.preload = "auto";
      stripVideo.src = src;
      var frameCount = 12;

      stripVideo.addEventListener("loadedmetadata", function () {
        var duration = stripVideo.duration;
        if (!isFinite(duration) || duration <= 0) {
          return;
        }
        var dpr = window.devicePixelRatio || 1;
        var canvasWidth = Math.max(1, Math.round(canvas.clientWidth * dpr));
        var canvasHeight = Math.max(1, Math.round(canvas.clientHeight * dpr));
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        var sliceWidth = canvasWidth / frameCount;
        ctx.fillStyle = "#0c0c0c";
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        var index = 0;

        var drawNext = function () {
          if (index >= frameCount) {
            return;
          }
          var t = (index / (frameCount - 1)) * duration;
          stripVideo.currentTime = t;
        };

        stripVideo.addEventListener("seeked", function handler() {
          try {
            var vW = stripVideo.videoWidth || 1;
            var vH = stripVideo.videoHeight || 1;
            var scale = Math.min(sliceWidth / vW, canvasHeight / vH);
            var drawW = vW * scale;
            var drawH = vH * scale;
            var dx = index * sliceWidth + (sliceWidth - drawW) / 2;
            var dy = (canvasHeight - drawH) / 2;
            ctx.drawImage(stripVideo, dx, dy, drawW, drawH);
          } catch (error) {
            return;
          }
          index += 1;
          if (index >= frameCount) {
            if (onDone) {
              onDone();
            }
            return;
          }
          drawNext();
        });

        drawNext();
      }, { once: true });
    }

    function scheduleStripBuild(side, force) {
      var preview = side === "left" ? leftPreview : rightPreview;
      var canvas = side === "left" ? leftStrip : rightStrip;
      var src = preview.currentSrc || preview.src;
      if (!src) {
        return;
      }
      if (!force) {
        if (side === "left" && leftStripBuilt && leftStripSrc === src) {
          return;
        }
        if (side === "right" && rightStripBuilt && rightStripSrc === src) {
          return;
        }
      }
      if (side === "left") {
        leftStripSrc = src;
        leftStripBuilt = false;
      } else {
        rightStripSrc = src;
        rightStripBuilt = false;
      }
      var run = function () {
        buildFrameStrip(preview, canvas, function () {
          if (side === "left") {
            leftStripBuilt = true;
          } else {
            rightStripBuilt = true;
          }
        });
      };
      if (isPlaying) {
        setTimeout(run, 400);
      } else if (window.requestIdleCallback) {
        window.requestIdleCallback(run, { timeout: 600 });
      } else {
        setTimeout(run, 200);
      }
    }

    function updateClipMaxes() {
      if (isFinite(v2.duration) && v2.duration > 0) {
        leftClipStart.max = v2.duration.toFixed(2);
        leftClipEnd.max = v2.duration.toFixed(2);
      }
      if (isFinite(v.duration) && v.duration > 0) {
        rightClipStart.max = v.duration.toFixed(2);
        rightClipEnd.max = v.duration.toFixed(2);
      }
    }

    function playPreview(previewVideo, startInput, endInput) {
      var segment = getSegment(previewVideo, startInput, endInput);
      if (segment.length <= 0) {
        return;
      }
      previewVideo.muted = true;
      previewVideo.volume = 0;
      try {
        previewVideo.currentTime = segment.start;
      } catch (error) {
        return;
      }
      previewVideo.play().catch(function () {});
    }

    function finalizeThumb(thumbVideo) {
      try {
        thumbVideo.currentTime = 0;
      } catch (error) {
        // Ignore seek errors on short or not-ready videos.
      }
      thumbVideo.pause();
    }

    function sampleVideoColor(video) {
      if (!video.videoWidth || !video.videoHeight) {
        return null;
      }
      var sampleWidth = 32;
      var sampleHeight = 18;
      glowCanvas.width = sampleWidth;
      glowCanvas.height = sampleHeight;
      var data;
      try {
        glowContext.drawImage(video, 0, 0, sampleWidth, sampleHeight);
        data = glowContext.getImageData(0, 0, sampleWidth, sampleHeight).data;
      } catch (error) {
        return null;
      }
      var r = 0;
      var g = 0;
      var b = 0;
      var count = data.length / 4;
      for (var i = 0; i < data.length; i += 4) {
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
      }
      return [r / count, g / count, b / count];
    }

    function updateGlowFromVideos() {
      var rightColor = sampleVideoColor(v);
      var leftColor = sampleVideoColor(v2);
      if (!rightColor && !leftColor) {
        return;
      }
      var r = 0;
      var g = 0;
      var b = 0;
      var count = 0;
      if (rightColor) {
        r += rightColor[0];
        g += rightColor[1];
        b += rightColor[2];
        count += 1;
      }
      if (leftColor) {
        r += leftColor[0];
        g += leftColor[1];
        b += leftColor[2];
        count += 1;
      }
      r = Math.round(r / count);
      g = Math.round(g / count);
      b = Math.round(b / count);
      document.documentElement.style.setProperty("--glow-r", r);
      document.documentElement.style.setProperty("--glow-g", g);
      document.documentElement.style.setProperty("--glow-b", b);
    }

    function startGlowLoop(video) {
      if (video.requestVideoFrameCallback) {
        var tick = function () {
          if (!video.paused) {
            updateGlowFromVideos();
          }
          video.requestVideoFrameCallback(tick);
        };
        video.requestVideoFrameCallback(tick);
        return;
      }
      if (glowInterval) {
        clearInterval(glowInterval);
      }
      glowInterval = setInterval(function () {
        if (!video.paused) {
          updateGlowFromVideos();
        }
      }, 120);
    }

    function setVideoSource(video, file, side) {
      if (!file) {
        return;
      }
      if (side === "left" && leftObjectUrl) {
        URL.revokeObjectURL(leftObjectUrl);
        leftObjectUrl = null;
      }
      if (side === "right" && rightObjectUrl) {
        URL.revokeObjectURL(rightObjectUrl);
        rightObjectUrl = null;
      }

      var objectUrl = URL.createObjectURL(file);
      if (side === "left") {
        leftObjectUrl = objectUrl;
      } else {
        rightObjectUrl = objectUrl;
      }

      v.pause();
      v2.pause();
      video.pause();
      video.src = objectUrl;
      video.load();
      v.currentTime = 0;
      v2.currentTime = 0;

      if (side === "left") {
        setThumbSource(leftThumb, objectUrl);
      } else {
        setThumbSource(rightThumb, objectUrl);
      }
    }

    leftFile.addEventListener("change", function () {
      setVideoSource(v2, leftFile.files[0], "left");
    });

    rightFile.addEventListener("change", function () {
      setVideoSource(v, rightFile.files[0], "right");
    });

    setAudioEnabled(leftAudio, isAudioEnabled(leftAudio));
    setAudioEnabled(rightAudio, isAudioEnabled(rightAudio));
    updateOffsetInputs();
    updateClipLabels();

    leftAudio.addEventListener("click", function () {
      setAudioEnabled(leftAudio, !isAudioEnabled(leftAudio));
      applyAudioSettings();
    });

    rightAudio.addEventListener("click", function () {
      setAudioEnabled(rightAudio, !isAudioEnabled(rightAudio));
      applyAudioSettings();
    });
    applyAudioSettings();

    leftLengthMode.addEventListener("click", function () {
      pauseMaster();
      applyAutoLength("left");
      updateMasterDuration();
      syncFromMaster(true);
      requestAnimationFrame(function () {
        requestPlayMaster("left-length");
      });
    });

    rightLengthMode.addEventListener("click", function () {
      pauseMaster();
      applyAutoLength("right");
      updateMasterDuration();
      syncFromMaster(true);
      requestAnimationFrame(function () {
        requestPlayMaster("right-length");
      });
    });

    function setLoopPriority(side) {
      if (side === "left") {
        setAudioEnabled(leftLoopPriority, true);
        setAudioEnabled(rightLoopPriority, false);
      } else {
        setAudioEnabled(rightLoopPriority, true);
        setAudioEnabled(leftLoopPriority, false);
      }
      pauseMaster();
      updateMasterDuration();
      syncFromMaster(true);
      requestAnimationFrame(function () {
        requestPlayMaster("loop-priority");
      });
    }

    leftLoopPriority.addEventListener("click", function () {
      if (!isAudioEnabled(leftLoopPriority)) {
        setLoopPriority("left");
      }
    });

    rightLoopPriority.addEventListener("click", function () {
      if (!isAudioEnabled(rightLoopPriority)) {
        setLoopPriority("right");
      }
    });

    setLoopPriority("right");

    lastRightOffset = parseFloat(rightOffset.value || "0");

    document.querySelectorAll(".settings-toggle").forEach(function (toggle) {
      toggle.addEventListener("click", function () {
        var card = toggle.closest(".control-card");
        var expanded = card.classList.toggle("expanded");
        toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
        if (expanded) {
          requestAnimationFrame(function () {
            requestAnimationFrame(function () {
              if (card.querySelector("#left-preview")) {
                scheduleStripBuild("left", false);
                updateTrimUI("left");
              } else {
                scheduleStripBuild("right", false);
                updateTrimUI("right");
              }
            });
          });
        }
      });
    });

    function syncOffsetInputToSlider(input, slider) {
      var value = parseNumber(input.value, 0);
      var min = parseNumber(slider.min, -2);
      var max = parseNumber(slider.max, 2);
      if (value < min) {
        slider.min = value;
      }
      if (value > max) {
        slider.max = value;
      }
      slider.value = value;
    }

    leftOffset.addEventListener("input", function () {
      updateOffsetInputs();
      syncFromMaster(true);
    });

    rightOffset.addEventListener("input", function () {
      lastRightOffset = parseFloat(rightOffset.value || "0");
      updateOffsetInputs();
      syncFromMaster(true);
    });

    leftOffsetValue.addEventListener("input", function () {
      syncOffsetInputToSlider(leftOffsetValue, leftOffset);
      updateOffsetInputs();
      syncFromMaster(true);
    });

    rightOffsetValue.addEventListener("input", function () {
      syncOffsetInputToSlider(rightOffsetValue, rightOffset);
      updateOffsetInputs();
      syncFromMaster(true);
    });

    masterPlayButton.addEventListener("click", function () {
      if (isPlaying) {
        pauseMaster();
      } else {
        requestPlayMaster("transport-play");
      }
    });

    masterScrubber.addEventListener("input", function () {
      isScrubbing = true;
      scrubPending = parseNumber(masterScrubber.value, 0);
      updateTransportUI();
      if (!scrubRAF) {
        scrubRAF = requestAnimationFrame(function () {
          scrubRAF = null;
          if (scrubPending !== null) {
            seekMaster(scrubPending);
          }
        });
      }
    });

    masterScrubber.addEventListener("pointerdown", function () {
      isScrubbing = true;
    });

    masterScrubber.addEventListener("pointerup", function () {
      isScrubbing = false;
      seekMaster(parseNumber(masterScrubber.value, 0));
    });

    masterScrubber.addEventListener("change", function () {
      isScrubbing = false;
      seekMaster(parseNumber(masterScrubber.value, 0));
    });

    speedButtons.forEach(function (button) {
      button.addEventListener("click", function () {
        var rate = parseNumber(button.dataset.rate, 1);
        playbackRate = rate > 0 ? rate : 1;
        v.playbackRate = playbackRate;
        v2.playbackRate = playbackRate;
        speedButtons.forEach(function (item) {
          item.classList.toggle("active", item === button);
        });
      });
    });

    lockSplitButton.addEventListener("click", function () {
      isSplitLocked = !isSplitLocked;
      lockSplitButton.dataset.locked = isSplitLocked ? "true" : "false";
      if (isSplitLocked) {
        lockSplitButton.classList.add("active");
      } else {
        lockSplitButton.classList.remove("active");
      }
    });

    masterFullscreen.addEventListener("click", function () {
      var container = document.querySelector(".player-shell");
      if (!document.fullscreenElement) {
        if (container.requestFullscreen) {
          container.requestFullscreen();
        }
      } else if (document.exitFullscreen) {
        document.exitFullscreen();
      }
    });

    document.addEventListener("fullscreenchange", function () {
      var container = document.querySelector(".player-shell");
      if (document.fullscreenElement === container) {
        fullscreenActive = true;
        document.body.classList.add("fullscreen-active");
        setFullscreenControlsVisible(true);
        fullscreenTip.classList.add("visible");
        if (fullscreenTimer) {
          clearTimeout(fullscreenTimer);
        }
        fullscreenTimer = setTimeout(function () {
          fullscreenTip.classList.remove("visible");
        }, 1400);
        fullscreenMoveHandler = handleFullscreenMove;
        document.addEventListener("mousemove", fullscreenMoveHandler);
        document.addEventListener("mousemove", function () {
          if (fullscreenActive) {
            setFullscreenControlsVisible(true);
            scheduleFullscreenHide(1800);
          }
        }, { once: true });
        scheduleFullscreenHide(600);
      } else {
        fullscreenActive = false;
        document.body.classList.remove("fullscreen-active");
        setFullscreenControlsVisible(false);
        if (fullscreenMoveHandler) {
          document.removeEventListener("mousemove", fullscreenMoveHandler);
          fullscreenMoveHandler = null;
        }
        if (fullscreenHideTimer) {
          clearTimeout(fullscreenHideTimer);
          fullscreenHideTimer = null;
        }
      }
    });

    [leftClipStart, leftClipEnd, rightClipStart, rightClipEnd].forEach(function (input) {
      input.addEventListener("input", function () {
        pauseMaster();
        clampClipRanges();
        updateClipLabels();
        updateMasterDuration();
        syncFromMaster(true);
        if (input === leftClipStart || input === leftClipEnd) {
          playPreview(leftPreview, leftClipStart, leftClipEnd);
        }
        if (input === rightClipStart || input === rightClipEnd) {
          playPreview(rightPreview, rightClipStart, rightClipEnd);
        }
        requestPlayMaster("clip-input");
      });
    });

    initTrimDrag("left");
    initTrimDrag("right");

    if (window.ResizeObserver) {
      var trimResizeObserver = new ResizeObserver(function () {
        updateTrimUI("left");
        updateTrimUI("right");
      });
      trimResizeObserver.observe(leftTimeline);
      trimResizeObserver.observe(rightTimeline);
    }

    function updateMuteOverlay() {
      var rightEnabled = isAudioEnabled(rightAudio);
      var leftEnabled = isAudioEnabled(leftAudio);
      var anyAudioEnabled = rightEnabled || leftEnabled;
      var showOverlay = !audioUnlocked && anyAudioEnabled;
      if (showOverlay) {
        muteOverlay.classList.add("visible");
      } else {
        muteOverlay.classList.remove("visible");
      }
    }

    function unmuteEnabled() {
      userInteracted = true;
      audioUnlocked = true;
      var rightEnabled = isAudioEnabled(rightAudio);
      var leftEnabled = isAudioEnabled(leftAudio);
      var masterSide = getMasterSide();
      var masterVideo = masterSide === "right" ? v : v2;
      updateAudioState(prevRightPadActive, prevLeftPadActive);
      updateMuteOverlay();
      dbg("unmuteEnabled", {
        rightEnabled: rightEnabled,
        leftEnabled: leftEnabled,
        rightMuted: v.muted,
        leftMuted: v2.muted
      });
      playMaster();
      var unlockPromise = masterVideo.play();
      if (unlockPromise && unlockPromise.catch) {
        unlockPromise.catch(function () {
          audioUnlocked = false;
          updateAudioState(prevRightPadActive, prevLeftPadActive);
          updateMuteOverlay();
        });
      }
    }

    muteOverlay.addEventListener("click", unmuteEnabled);
    muteOverlay.addEventListener("keydown", function (event) {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        unmuteEnabled();
      }
    });

    function attemptAutoplay(force) {
      if (autoplayAttempted && !force) {
        return;
      }
      autoplayAttempted = true;
      v.muted = true;
      v2.muted = true;
      updateAudioState(prevRightPadActive, prevLeftPadActive);
      dbg("attemptAutoplay", { force: force });
      var playPromise = Promise.all([v.play(), v2.play()]);
      if (playPromise && playPromise.catch) {
        playPromise.catch(function () {
          v.muted = true;
          v2.muted = true;
          updateMuteOverlay();
        });
      }
      requestPlayMaster("autoplay");
    }

    function primeThumbs() {
      setThumbSource(leftThumb, getVideoSrc(v2));
      setThumbSource(rightThumb, getVideoSrc(v));
      setPreviewSource(leftPreview, getVideoSrc(v2));
      setPreviewSource(rightPreview, getVideoSrc(v));
      scheduleStripBuild("left", true);
      scheduleStripBuild("right", true);
      ensureClipDefaults(v2, leftClipStart, leftClipEnd);
      ensureClipDefaults(v, rightClipStart, rightClipEnd);
    }

    window.addEventListener("load", function () {
      attemptAutoplay(false);
      primeThumbs();
      updateMuteOverlay();
      updateClipLabels();
      updateTransportUI();
      requestAnimationFrame(function () {
        updateTrimUI("left");
        updateTrimUI("right");
      });
    });

    window.addEventListener("resize", function () {
      updateTrimUI("left");
      updateTrimUI("right");
    });

    document.addEventListener("pointerdown", function () {
      userInteracted = true;
      autoplayAttempted = false;
      applyAudioSettings();
      attemptAutoplay(true);
    }, { once: true });

    v.addEventListener("loadeddata", function () {
      setThumbSource(rightThumb, getVideoSrc(v));
      setPreviewSource(rightPreview, getVideoSrc(v));
      scheduleStripBuild("right", true);
      attemptAutoplay(true);
      updateGlowFromVideos();
      startGlowLoop(v);
      updateMuteOverlay();
      lastRightOffset = parseFloat(rightOffset.value || "0");
      ensureClipDefaults(v, rightClipStart, rightClipEnd);
      rightClipStart.value = "0";
      rightClipEnd.value = v.duration.toFixed(2);
      updateClipMaxes();
      updateClipLabels();
      updateTrimUI("right");
      updateMasterDuration();
      syncFromMaster(true);
    });

    v2.addEventListener("loadeddata", function () {
      setThumbSource(leftThumb, getVideoSrc(v2));
      setPreviewSource(leftPreview, getVideoSrc(v2));
      scheduleStripBuild("left", true);
      attemptAutoplay(true);
      updateMuteOverlay();
      ensureClipDefaults(v2, leftClipStart, leftClipEnd);
      leftClipStart.value = "0";
      leftClipEnd.value = v2.duration.toFixed(2);
      updateClipMaxes();
      updateClipLabels();
      updateTrimUI("left");
      updateMasterDuration();
      syncFromMaster(true);
    });

    leftThumb.addEventListener("loadeddata", function () {
      finalizeThumb(leftThumb);
    });

    rightThumb.addEventListener("loadeddata", function () {
      finalizeThumb(rightThumb);
    });

    leftPreview.addEventListener("timeupdate", function () {
      var segment = getSegment(leftPreview, leftClipStart, leftClipEnd);
      if (segment.length > 0 && leftPreview.currentTime >= segment.end) {
        leftPreview.currentTime = segment.start;
      }
    });

    rightPreview.addEventListener("timeupdate", function () {
      var segment = getSegment(rightPreview, rightClipStart, rightClipEnd);
      if (segment.length > 0 && rightPreview.currentTime >= segment.end) {
        rightPreview.currentTime = segment.start;
      }
    });

    function video_click() {
      if (!isPlaying){
        requestPlayMaster("toggle-play");
      }
      else{
        pauseMaster();
      }
    }

    function updateMasterDuration() {
      var rightSeg = getSegment(v, rightClipStart, rightClipEnd);
      var leftSeg = getSegment(v2, leftClipStart, leftClipEnd);
      var masterSide = getMasterSide();
      var masterLen = masterSide === "right" ? rightSeg.length : leftSeg.length;
      var fallbackLen = masterSide === "right" ? leftSeg.length : rightSeg.length;
      masterDuration = masterLen || fallbackLen || 0;
      if (!isFinite(masterDuration) || masterDuration <= 0) {
        masterDuration = 0;
      }
      if (masterDuration > 0) {
        masterTime = wrapTime(masterTime, masterDuration);
      }
    }

    function tick(now) {
      if (!isPlaying) {
        return;
      }
      syncFromMaster(false);
      requestAnimationFrame(tick);
    }

    function playMaster() {
      ensureClipDefaults(v2, leftClipStart, leftClipEnd);
      ensureClipDefaults(v, rightClipStart, rightClipEnd);
      updateClipMaxes();
      applyAudioSettings();
      updateMasterDuration();
      if (masterDuration <= 0) {
        ensureClipDefaults(v2, leftClipStart, leftClipEnd);
        ensureClipDefaults(v, rightClipStart, rightClipEnd);
        updateMasterDuration();
        if (masterDuration <= 0) {
          return;
        }
      }
      playToken += 1;
      var token = playToken;
      dbg("playMaster", { token: token, masterDuration: masterDuration, masterTime: masterTime });
      var masterSide = getMasterSide();
      var masterVideo = masterSide === "right" ? v : v2;
      var otherVideo = masterSide === "right" ? v2 : v;
      masterVideo.playbackRate = playbackRate;
      otherVideo.playbackRate = playbackRate;
      if (!isPlaying) {
        isPlaying = true;
        lastTick = null;
        requestAnimationFrame(tick);
        if (masterVideo.paused) {
          masterVideo.play().catch(function () {});
        }
        if (!otherVideo.paused) {
          otherVideo.pause();
        }
      }
      requestAnimationFrame(function () {
        if (token !== playToken) {
          return;
        }
        syncFromMaster(true);
      });
    }

    function requestPlayMaster(reason) {
      if (playQueued) {
        return;
      }
      playQueued = true;
      requestAnimationFrame(function () {
        playQueued = false;
        dbg("requestPlayMaster", { reason: reason || "unknown" });
        playMaster();
      });
    }

    function pauseMaster() {
      isPlaying = false;
      playToken += 1;
      v.pause();
      v2.pause();
      updateTransportUI();
    }

    function setMasterFromRight() {
      // Deprecated: master time now derived from the prioritized video in syncFromMaster.
    }

    function setFullscreenControlsVisible(visible) {
      fullscreenControlsVisible = visible;
      if (visible) {
        document.body.classList.add("fullscreen-controls-visible");
      } else {
        document.body.classList.remove("fullscreen-controls-visible");
      }
    }

    function scheduleFullscreenHide(delay) {
      if (fullscreenHideTimer) {
        clearTimeout(fullscreenHideTimer);
      }
      fullscreenHideTimer = setTimeout(function () {
        setFullscreenControlsVisible(false);
      }, delay);
    }

    function handleFullscreenMove(event) {
      if (!fullscreenActive) {
        return;
      }
      var threshold = window.innerHeight - 120;
      if (event.clientY >= threshold) {
        setFullscreenControlsVisible(true);
        scheduleFullscreenHide(2000);
      } else {
        scheduleFullscreenHide(500);
      }
    }

    function seekMaster(targetSeconds) {
      updateMasterDuration();
      var masterSide = getMasterSide();
      var masterVideo = masterSide === "right" ? v : v2;
      var masterSeg = masterSide === "right" ? getSegment(v, rightClipStart, rightClipEnd) : getSegment(v2, leftClipStart, leftClipEnd);
      var masterOffset = masterSide === "right" ? parseNumber(rightOffset.value, 0) : parseNumber(leftOffset.value, 0);
      var otherVideo = masterSide === "right" ? v2 : v;
      var otherSeg = masterSide === "right" ? getSegment(v2, leftClipStart, leftClipEnd) : getSegment(v, rightClipStart, rightClipEnd);
      var otherOffset = masterSide === "right" ? parseNumber(leftOffset.value, 0) : parseNumber(rightOffset.value, 0);
      if (!(masterSeg.length > 0)) {
        return;
      }
      var target = masterSeg.start + wrapTime(targetSeconds + masterOffset, masterSeg.length);
      masterVideo.currentTime = target;
      if (otherSeg.length > 0) {
        var otherRelative = targetSeconds + otherOffset;
        var otherTarget = otherSeg.start;
        if (otherRelative < 0) {
          otherTarget = otherSeg.start;
        } else if (otherRelative >= otherSeg.length) {
          otherTarget = Math.max(otherSeg.start, otherSeg.end - 0.02);
        } else {
          otherTarget = otherSeg.start + otherRelative;
        }
        otherVideo.currentTime = otherTarget;
      }
      masterTime = wrapTime(targetSeconds, masterSeg.length);
      syncFromMaster(true);
      if (isPlaying && masterVideo.paused) {
        masterVideo.play().catch(function () {});
      }
    }

    var videoContainer = document.getElementById("video-compare-container"),
    videoClipper = document.getElementById("video-clipper"),
    clippedVideo = videoClipper.getElementsByTagName("video")[0];

    function trackLocation(e) {
      if (isSplitLocked) {
        return;
      }
      var rect = videoContainer.getBoundingClientRect(),
        position = ((e.pageX - rect.left) / videoContainer.offsetWidth) * 100;
      if (position <= 100) {
        videoClipper.style.width = position + "%";
        clippedVideo.style.width = ((100 / position) * 100) + "%";
        clippedVideo.style.zIndex = 3;
      }
    }
    videoContainer.addEventListener("mousemove", trackLocation, false);
    videoContainer.addEventListener("touchstart", trackLocation, { passive: true });
    videoContainer.addEventListener("touchmove", trackLocation, { passive: true });
  </script>
</body>
</html>
